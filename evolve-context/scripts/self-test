#!/usr/bin/env bash
# Self-test for evolve-context skill
# Validates: validate-context, three-layer architecture, protocols, templates
set -euo pipefail

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
SKILL_DIR="$(dirname "$SCRIPT_DIR")"
VALIDATOR="$SKILL_DIR/scripts/validate-context"

PASS=0
FAIL=0
TOTAL=0

assert() {
  local desc=$1
  TOTAL=$((TOTAL + 1))
  if eval "$2" >/dev/null 2>&1; then
    echo "  ✓ $desc"
    PASS=$((PASS + 1))
  else
    echo "  ✗ $desc"
    FAIL=$((FAIL + 1))
  fi
}

echo ">>> SELF-TEST: evolve-context <<<"
echo

# --- File structure (three-layer architecture) ---
echo "Three-Layer Architecture:"
assert "Layer 0: README.md exists"           "[[ -f '$SKILL_DIR/README.md' ]]"
assert "Layer 1: AGENTS.md (index) exists"   "[[ -f '$SKILL_DIR/AGENTS.md' ]]"
assert "Layer 2: docs/README.md exists"      "[[ -f '$SKILL_DIR/docs/README.md' ]]"
assert "Layer 3: docs/ directory exists"     "[[ -d '$SKILL_DIR/docs' ]]"
assert "SKILL.md exists"                     "[[ -f '$SKILL_DIR/SKILL.md' ]]"
assert "CHANGELOG.md exists"                 "[[ -f '$SKILL_DIR/CHANGELOG.md' ]]"
echo

# --- Connectivity invariant ---
echo "Connectivity Invariant:"
assert "README → docs/README.md link"  "grep -q 'docs/README.md' '$SKILL_DIR/README.md'"
assert "README → AGENTS.md link"       "grep -q 'AGENTS.md' '$SKILL_DIR/README.md'"
assert "SKILL.md → protocols.md link"  "grep -q 'protocols.md' '$SKILL_DIR/SKILL.md'"
assert "SKILL.md → templates.md link"  "grep -q 'templates.md' '$SKILL_DIR/SKILL.md'"
echo

# --- Docs index coverage ---
echo "Docs Index Coverage:"
ORPHANS=0
PHANTOMS=0
while IFS= read -r -d '' doc_file; do
  doc_name=$(basename "$doc_file")
  if ! grep -qF "$doc_name" "$SKILL_DIR/docs/README.md" 2>/dev/null; then
    ORPHANS=$((ORPHANS + 1))
    echo "    orphan: $doc_name"
  fi
done < <(find "$SKILL_DIR/docs" -name '*.md' ! -name 'README.md' -print0)
assert "No orphaned docs" "[[ $ORPHANS -eq 0 ]]"
echo

# --- validate-context ---
echo "Validator (validate-context):"
assert "Validator script exists" "[[ -f '$VALIDATOR' ]]"

# Test on self (the skill itself should pass)
SELF_OUT=$(cd "$SKILL_DIR" && VALIDATE_CONTEXT_ROOT=. bash "$VALIDATOR" 2>&1)
SELF_EXIT=$?
assert "Self-validation passes (exit 0)" "[[ $SELF_EXIT -eq 0 ]]"
assert "No errors in self-validation" "grep -q 'Errors: 0' <<< '$SELF_OUT'"

# Test JSON mode
JSON_OUT=$(cd "$SKILL_DIR" && VALIDATE_CONTEXT_ROOT=. bash "$VALIDATOR" --json 2>&1)
assert "JSON mode produces valid structure" "grep -q '\"passed\"' <<< '$JSON_OUT'"
assert "JSON has items array" "grep -q '\"items\"' <<< '$JSON_OUT'"
echo

# --- Validator detection capabilities ---
echo "Validator Detection Tests:"

# Create a temp project with known issues
TMPDIR=$(mktemp -d)
trap 'rm -rf "$TMPDIR"' EXIT

# Test 1: No index file → should fail
NOINDEX_OUT=$(cd "$TMPDIR" && VALIDATE_CONTEXT_ROOT=. bash "$VALIDATOR" 2>&1 || true)
assert "Detects missing index file" "grep -qi 'no index file found\|FAIL' <<< '$NOINDEX_OUT'"

# Test 2: Minimal valid project
mkdir -p "$TMPDIR/docs"
cat > "$TMPDIR/README.md" << 'EOF'
# Test Project
- [Project Index](AGENTS.md)
- [Docs](docs/README.md)
EOF
cat > "$TMPDIR/AGENTS.md" << 'EOF'
# AGENTS.md
## 1. Overall Concept
Test project.
## Meta-Protocol Principles
- Test
## Change History
- `[2025-01-01]` Initial
EOF
cat > "$TMPDIR/docs/README.md" << 'EOF'
# Docs Index
EOF

VALID_OUT=$(cd "$TMPDIR" && VALIDATE_CONTEXT_ROOT=. bash "$VALIDATOR" 2>&1)
VALID_EXIT=$?
assert "Minimal valid project passes" "[[ $VALID_EXIT -eq 0 ]]"

# Test 3: Broken link detection
cat > "$TMPDIR/docs/broken.md" << 'EOF'
[missing link](./nonexistent.md)
EOF
cat >> "$TMPDIR/docs/README.md" << 'EOF'
- [broken](./broken.md)
EOF
BROKEN_OUT=$(cd "$TMPDIR" && VALIDATE_CONTEXT_ROOT=. bash "$VALIDATOR" 2>&1 || true)
assert "Detects broken links" "grep -qi 'broken link\|FAIL' <<< '$BROKEN_OUT'"
echo

# --- SKILL.md structure ---
echo "SKILL.md Structure:"
assert "Has version in frontmatter"  "grep -q 'version:' '$SKILL_DIR/SKILL.md'"
assert "Has Purpose section"         "grep -q '## Purpose' '$SKILL_DIR/SKILL.md'"
assert "Has Axioms section"          "grep -q '## Axioms' '$SKILL_DIR/SKILL.md'"
assert "Has Activation Modes"        "grep -q '## Activation Modes\|### Mode' '$SKILL_DIR/SKILL.md'"
assert "Has Tooling section"         "grep -q '## Tooling\|validate-context' '$SKILL_DIR/SKILL.md'"
echo

# --- AGENTS.md sections ---
echo "AGENTS.md Sections:"
assert "Has Meta-Protocol Principles" "grep -q 'Meta-Protocol Principles' '$SKILL_DIR/AGENTS.md'"
assert "Has Discovered Constraints"   "grep -q 'Discovered Constraints' '$SKILL_DIR/AGENTS.md'"
assert "Has Change History"           "grep -q 'Change History' '$SKILL_DIR/AGENTS.md'"
CH_ENTRIES=$(grep -cE '^\s*-\s*`\[[0-9]{4}-[0-9]{2}-[0-9]{2}\]`' "$SKILL_DIR/AGENTS.md" || true)
assert "Change History ≤ 5 entries ($CH_ENTRIES)" "[[ $CH_ENTRIES -le 5 ]]"
echo

# --- Platform compatibility ---
echo "Platform Compatibility:"
assert "Uses stat with macOS fallback" "grep -q 'stat -f' '$VALIDATOR'"
assert "No grep -P usage"             "! grep -q 'grep -P' '$VALIDATOR'"
assert "No GNU realpath --relative-to invocation" "! grep -qE '(^|[^#].*)realpath --relative-to=' '$VALIDATOR'"
assert "Has set -euo pipefail"        "head -10 '$VALIDATOR' | grep -q 'set -euo pipefail'"
assert "Has ERR trap"                 "grep -q 'trap.*ERR' '$VALIDATOR'"
echo

# --- Summary ---
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "Results: $PASS/$TOTAL passed, $FAIL failed"
if [[ $FAIL -eq 0 ]]; then
  echo "✅ All tests passed"
  exit 0
else
  echo "❌ $FAIL test(s) failed"
  exit 1
fi
