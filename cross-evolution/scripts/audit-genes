#!/usr/bin/env bash
# audit-genes â€” Gene Ã— Skill matrix with fitness scoring and gene discovery.
# Reads gene definitions from docs/genes.md (markdown tables).
# Part of the cross-evolution skill.
set -euo pipefail

trap 'echo "RUNTIME ERROR: audit-genes crashed at line $LINENO (exit code $?)" >&2' ERR

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
SKILL_DIR="$(dirname "$SCRIPT_DIR")"
GENES_FILE="$SKILL_DIR/docs/genes.md"
OS_TYPE="$(uname -s)"

DEFAULT_SKILLS_DIR="${SKILLS_HOME:-$HOME/.skills}"
LOCAL_SKILLS_DIR="$(dirname "$SKILL_DIR")"
SKILLS_DIR=""
DISCOVER_NEW_GENES=true
SYNC_DISCOVERED=true

usage() {
  cat <<'EOF'
Usage:
  audit-genes [skills_dir] [--no-discovery] [--no-sync-discovery]

Options:
  --no-discovery       Skip candidate gene discovery phase.
  --no-sync-discovery  Discover candidates but do not write them into docs/genes.md.
  -h, --help           Show this help.

Defaults:
  skills_dir = $SKILLS_HOME (or ~/.skills) if it exists, else sibling skills directory next to cross-evolution.
EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --no-discovery)
      DISCOVER_NEW_GENES=false
      ;;
    --no-sync-discovery)
      SYNC_DISCOVERED=false
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      if [[ -z "$SKILLS_DIR" ]]; then
        SKILLS_DIR="$1"
      else
        echo "ERROR: unexpected argument '$1'" >&2
        usage
        exit 1
      fi
      ;;
  esac
  shift
done

if [[ -z "$SKILLS_DIR" ]]; then
  if [[ -d "$DEFAULT_SKILLS_DIR" ]]; then
    SKILLS_DIR="$DEFAULT_SKILLS_DIR"
  else
    SKILLS_DIR="$LOCAL_SKILLS_DIR"
  fi
fi

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

if [[ ! -f "$GENES_FILE" ]]; then
  echo "ERROR: docs/genes.md not found at $GENES_FILE" >&2
  exit 1
fi

declare -a GENE_IDS=()
declare -A GENE_NAMES=()
declare -A GENE_DETECT_TYPE=()
declare -A GENE_DETECT_ARGS=()
declare -A GENE_RECOMMEND=()
declare -A GENE_WEIGHT=()

declare -a CONFLICT_A=()
declare -a CONFLICT_B=()
declare -a CONFLICT_DESC=()
declare -a CONFLICT_RESOLUTION=()

SECTION=""
HEADER_SKIPPED=false

while IFS= read -r line; do
  if [[ "$line" =~ ^##\  ]]; then
    SECTION="$line"
    HEADER_SKIPPED=false
    continue
  fi

  [[ "$line" != \|* ]] && continue
  [[ "$line" =~ ^\|[-[:space:]:.|]+$ ]] && continue

  if [[ "$HEADER_SKIPPED" == "false" ]]; then
    HEADER_SKIPPED=true
    continue
  fi

  case "$SECTION" in
    "## Active Genes")
      stripped=$(echo "$line" | sed 's/^ *| *//;s/ *| *$//')
      gid=$(echo "$stripped"     | awk -F ' \\| ' '{print $1}' | sed 's/^ *//;s/ *$//')
      gname=$(echo "$stripped"   | awk -F ' \\| ' '{print $2}' | sed 's/^ *//;s/ *$//')
      gtype=$(echo "$stripped"   | awk -F ' \\| ' '{print $3}' | sed 's/^ *//;s/ *$//')
      gargs=$(echo "$stripped"   | awk -F ' \\| ' '{print $4}' | sed 's/^ *//;s/ *$//;s/\\|/|/g')
      gscope=$(echo "$stripped"  | awk -F ' \\| ' '{print $5}' | sed 's/^ *//;s/ *$//')
      gweight=$(echo "$stripped" | awk -F ' \\| ' '{print $6}' | sed 's/^ *//;s/ *$//')

      [[ -z "$gid" || "$gid" == *"none"* ]] && continue

      GENE_IDS+=("$gid")
      GENE_NAMES[$gid]="$gname"
      GENE_DETECT_TYPE[$gid]="$gtype"
      GENE_DETECT_ARGS[$gid]="$gargs"
      GENE_RECOMMEND[$gid]="$gscope"
      GENE_WEIGHT[$gid]="${gweight:-1}"
      ;;
    "## Gene Conflicts")
      stripped=$(echo "$line" | sed 's/^ *| *//;s/ *| *$//')
      ca=$(echo "$stripped" | awk -F ' \\| ' '{print $1}' | sed 's/^ *//;s/ *$//')
      cb=$(echo "$stripped" | awk -F ' \\| ' '{print $2}' | sed 's/^ *//;s/ *$//')
      cd=$(echo "$stripped" | awk -F ' \\| ' '{print $3}' | sed 's/^ *//;s/ *$//')
      cr=$(echo "$stripped" | awk -F ' \\| ' '{print $4}' | sed 's/^ *//;s/ *$//')

      [[ -z "$ca" || "$ca" == *"none"* ]] && continue

      CONFLICT_A+=("$ca")
      CONFLICT_B+=("$cb")
      CONFLICT_DESC+=("$cd")
      CONFLICT_RESOLUTION+=("$cr")
      ;;
  esac
done < "$GENES_FILE"

if [[ ${#GENE_IDS[@]} -eq 0 ]]; then
  echo "ERROR: No active genes found in $GENES_FILE" >&2
  exit 1
fi

detect_gene() {
  local skill_dir=$1
  local dtype=$2
  local dargs=$3

  case "$dtype" in
    file)
      [[ -f "$skill_dir/$dargs" ]] || [[ -d "$skill_dir/$dargs" ]]
      ;;
    file_any)
      IFS=',' read -ra paths <<< "$dargs"
      for p in "${paths[@]}"; do
        p=$(echo "$p" | sed 's/^ *//;s/ *$//')
        [[ -f "$skill_dir/$p" ]] || [[ -d "$skill_dir/$p" ]] && return 0
      done
      return 1
      ;;
    dir)
      [[ -d "$skill_dir/$dargs" ]]
      ;;
    grep_scripts)
      [[ -d "$skill_dir/scripts" ]] || return 1
      for script in "$skill_dir/scripts/"*; do
        [[ -f "$script" ]] || continue
        if grep -qEl "$dargs" "$script" 2>/dev/null; then
          return 0
        fi
      done
      return 1
      ;;
    grep_docs)
      local doc_files=()
      local doc
      for doc in SKILL.md README.md AGENTS.md docs/README.md; do
        [[ -f "$skill_dir/$doc" ]] && doc_files+=("$skill_dir/$doc")
      done
      [[ ${#doc_files[@]} -gt 0 ]] || return 1
      grep -qEl "$dargs" "${doc_files[@]}" 2>/dev/null
      ;;
    *)
      return 1
      ;;
  esac
}

skill_has_scripts() {
  local skill_dir=$1
  [[ -d "$skill_dir/scripts" ]] || return 1
  find "$skill_dir/scripts" -maxdepth 1 -type f | read -r _
}

gene_exists_in_registry() {
  local gid=$1
  grep -qE "^\|[[:space:]]*$gid[[:space:]]*\|" "$GENES_FILE"
}

append_proposed_gene() {
  local gid=$1
  local gname=$2
  local gtype=$3
  local gargs=$4
  local gscope=$5
  local gweight=$6
  local gdesc=$7

  gene_exists_in_registry "$gid" && return 0

  local args_escaped="${gargs//|/\\|}"
  local today
  today="$(date +%F)"
  local row="| $gid | $gname | $gtype | $args_escaped | $gscope | $gweight | $gdesc | $today |"

  local tmp_file
  local tmp_base="${TMPDIR:-$HOME/.cache/cross-evolution}"
  mkdir -p "$tmp_base"
  tmp_file=$(mktemp "${tmp_base%/}/genes_registry_XXXXXX")

  if ! awk -v row="$row" '
    BEGIN {in_prop=0; inserted=0}
    /^## Proposed Genes$/ {in_prop=1}
    in_prop && /^\| _\(none yet\)_ \|/ {
      print row
      inserted=1
      next
    }
    in_prop && /^## Active Genes$/ && !inserted {
      print row
      inserted=1
    }
    {print}
    END { if (!inserted) exit 1 }
  ' "$GENES_FILE" > "$tmp_file"; then
    rm -f "$tmp_file"
    echo "  ${YELLOW}âš  Could not append proposed gene '$gid' (Proposed section not found).${NC}"
    return 1
  fi

  mv "$tmp_file" "$GENES_FILE"
  echo "  ${GREEN}+ Added proposed gene '$gid' to docs/genes.md${NC}"
  return 0
}

declare -a SKILLS=()
declare -A SKILL_PATHS=()

while IFS= read -r -d '' skill_md; do
  skill_dir="$(dirname "$skill_md")"
  skill_id="${skill_dir#$SKILLS_DIR/}"
  if [[ "$skill_id" == "$skill_dir" ]]; then
    skill_id="$(basename "$skill_dir")"
  fi
  SKILLS+=("$skill_id")
  SKILL_PATHS["$skill_id"]="$skill_dir"
done < <(find "$SKILLS_DIR" -type f -name "SKILL.md" ! -path "*/.git/*" -print0 2>/dev/null)

if [[ ${#SKILLS[@]} -eq 0 ]]; then
  echo "No skills found in $SKILLS_DIR"
  exit 1
fi

mapfile -t SKILLS < <(printf '%s\n' "${SKILLS[@]}" | awk '!seen[$0]++' | sort)

declare -A DETECTED=()

for skill in "${SKILLS[@]}"; do
  skill_dir="${SKILL_PATHS[$skill]}"
  for gid in "${GENE_IDS[@]}"; do
    if detect_gene "$skill_dir" "${GENE_DETECT_TYPE[$gid]}" "${GENE_DETECT_ARGS[$gid]}" 2>/dev/null; then
      DETECTED["$skill:$gid"]=1
    else
      DETECTED["$skill:$gid"]=0
    fi
  done
done

echo -e "${CYAN}>>> CROSS-EVOLUTION GENE AUDIT <<<${NC}"
echo -e "${CYAN}Skills root: $SKILLS_DIR${NC}"
echo

MAX_NAME_LEN=10
for gid in "${GENE_IDS[@]}"; do
  len=${#GENE_NAMES[$gid]}
  (( len > MAX_NAME_LEN )) && MAX_NAME_LEN=$len
done
COL_WIDTH=$((MAX_NAME_LEN + 4))

printf "%-28s" "Skill"
for gid in "${GENE_IDS[@]}"; do
  printf "  %-${COL_WIDTH}s" "$gid"
done
echo

printf "%-28s" "$(printf 'â”€%.0s' {1..28})"
for gid in "${GENE_IDS[@]}"; do
  printf "  %-${COL_WIDTH}s" "$(printf 'â”€%.0s' $(seq 1 $COL_WIDTH))"
done
echo

for skill in "${SKILLS[@]}"; do
  printf "%-28s" "$skill"
  for gid in "${GENE_IDS[@]}"; do
    if [[ "${DETECTED[$skill:$gid]}" == "1" ]]; then
      printf "  ${GREEN}âœ“ %-$((COL_WIDTH - 2))s${NC}" "${GENE_NAMES[$gid]}"
    else
      printf "  ${RED}âœ— %-$((COL_WIDTH - 2))s${NC}" "${GENE_NAMES[$gid]}"
    fi
  done
  echo
done

echo
echo -e "${BOLD}Fitness Scores:${NC}"
echo

for skill in "${SKILLS[@]}"; do
  skill_dir="${SKILL_PATHS[$skill]}"
  has_scripts=false
  if skill_has_scripts "$skill_dir"; then
    has_scripts=true
  fi

  earned=0
  possible=0

  for gid in "${GENE_IDS[@]}"; do
    w=${GENE_WEIGHT[$gid]}
    scope=${GENE_RECOMMEND[$gid]}
    present=${DETECTED[$skill:$gid]}

    applicable=false
    case "$scope" in
      all) applicable=true ;;
      has_scripts) $has_scripts && applicable=true ;;
      none) [[ "$present" == "1" ]] && applicable=true ;;
    esac

    if $applicable; then
      possible=$((possible + w))
      [[ "$present" == "1" ]] && earned=$((earned + w))
    fi
  done

  if [[ $possible -gt 0 ]]; then
    fitness=$((earned * 100 / possible))
  else
    fitness=0
  fi

  if [[ $fitness -ge 80 ]]; then
    rating="${GREEN}ðŸŸ¢ Excellent${NC}"
  elif [[ $fitness -ge 50 ]]; then
    rating="${YELLOW}ðŸŸ¡ Moderate${NC}"
  else
    rating="${RED}ðŸ”´ Low${NC}"
  fi

  printf "  %-28s %3d%% (%d/%d)  %b\n" "$skill" "$fitness" "$earned" "$possible" "$rating"
done

if [[ ${#CONFLICT_A[@]} -gt 0 ]]; then
  FOUND_CONFLICTS=false
  for i in "${!CONFLICT_A[@]}"; do
    ca="${CONFLICT_A[$i]}"
    cb="${CONFLICT_B[$i]}"
    for skill in "${SKILLS[@]}"; do
      if [[ "${DETECTED[$skill:$ca]:-0}" == "1" && "${DETECTED[$skill:$cb]:-0}" == "1" ]]; then
        if [[ "$FOUND_CONFLICTS" == "false" ]]; then
          echo
          echo -e "${RED}${BOLD}Gene Conflicts Detected:${NC}"
          FOUND_CONFLICTS=true
        fi
        echo -e "  ${YELLOW}âš¡ ${skill}: ${ca} Ã— ${cb}${NC} â€” ${CONFLICT_DESC[$i]}"
        echo -e "     Resolution: ${CONFLICT_RESOLUTION[$i]}"
      fi
    done
  done
fi

echo
echo -e "${BOLD}Genetic Drift:${NC}"
DRIFT_COUNT=0
for gid in "${GENE_IDS[@]}"; do
  carriers=0
  for skill in "${SKILLS[@]}"; do
    [[ "${DETECTED[$skill:$gid]}" == "1" ]] && carriers=$((carriers + 1))
  done
  if [[ $carriers -eq 0 ]]; then
    echo -e "  ${YELLOW}â˜  ${gid}${NC} â€” carried by 0/${#SKILLS[@]} skills (candidate for deprecation)"
    DRIFT_COUNT=$((DRIFT_COUNT + 1))
  fi
done
if [[ $DRIFT_COUNT -eq 0 ]]; then
  echo "  No genes at risk of extinction."
fi

echo
echo -e "${BOLD}Recommendations:${NC}"
RECS=0

for skill in "${SKILLS[@]}"; do
  skill_dir="${SKILL_PATHS[$skill]}"
  has_scripts=false
  if skill_has_scripts "$skill_dir"; then
    has_scripts=true
  fi

  for gid in "${GENE_IDS[@]}"; do
    [[ "${DETECTED[$skill:$gid]}" == "1" ]] && continue

    scope="${GENE_RECOMMEND[$gid]}"
    case "$scope" in
      all)
        echo "  â†’ $skill: ${GENE_NAMES[$gid]} ($gid, weight=${GENE_WEIGHT[$gid]})"
        RECS=$((RECS + 1))
        ;;
      has_scripts)
        if $has_scripts; then
          echo "  â†’ $skill: ${GENE_NAMES[$gid]} ($gid, weight=${GENE_WEIGHT[$gid]})"
          RECS=$((RECS + 1))
        fi
        ;;
      none) ;;
    esac
  done
done

if [[ $RECS -eq 0 ]]; then
  echo "  All applicable genes are present. Ecosystem is healthy."
fi

echo
echo -e "${BOLD}Gene Discovery:${NC}"
if [[ "$DISCOVER_NEW_GENES" == "false" ]]; then
  echo "  Discovery disabled via --no-discovery."
  exit 0
fi

declare -a DISCOVER_IDS=(
  "ui-metadata"
  "python-tooling"
  "cli-arguments"
  "license-file"
)

declare -A DISCOVER_NAME=(
  ["ui-metadata"]="UI metadata"
  ["python-tooling"]="Python tooling"
  ["cli-arguments"]="CLI arguments"
  ["license-file"]="License file"
)

declare -A DISCOVER_DETECT_TYPE=(
  ["ui-metadata"]="file"
  ["python-tooling"]="grep_scripts"
  ["cli-arguments"]="grep_scripts"
  ["license-file"]="file_any"
)

declare -A DISCOVER_DETECT_ARGS=(
  ["ui-metadata"]="agents/openai.yaml"
  ["python-tooling"]="#!/usr/bin/env python3"
  ["cli-arguments"]="argparse|getopts|ArgumentParser"
  ["license-file"]="LICENSE,LICENSE.txt,license.txt"
)

declare -A DISCOVER_RECOMMEND=(
  ["ui-metadata"]="none"
  ["python-tooling"]="has_scripts"
  ["cli-arguments"]="has_scripts"
  ["license-file"]="none"
)

declare -A DISCOVER_WEIGHT=(
  ["ui-metadata"]="1"
  ["python-tooling"]="1"
  ["cli-arguments"]="1"
  ["license-file"]="1"
)

declare -A DISCOVER_DESC=(
  ["ui-metadata"]="Skill ships agents/openai.yaml for UI integration"
  ["python-tooling"]="Skill provides Python automation scripts"
  ["cli-arguments"]="Scripts expose CLI argument parsing"
  ["license-file"]="Skill includes explicit license text"
)

declare -A DISCOVER_MIN_CARRIERS=(
  ["ui-metadata"]="2"
  ["python-tooling"]="2"
  ["cli-arguments"]="2"
  ["license-file"]="2"
)

declare -a DISCOVERED_IDS=()

for gid in "${DISCOVER_IDS[@]}"; do
  if gene_exists_in_registry "$gid"; then
    continue
  fi

  carriers=0
  for skill in "${SKILLS[@]}"; do
    skill_dir="${SKILL_PATHS[$skill]}"
    if detect_gene "$skill_dir" "${DISCOVER_DETECT_TYPE[$gid]}" "${DISCOVER_DETECT_ARGS[$gid]}" 2>/dev/null; then
      carriers=$((carriers + 1))
    fi
  done

  if [[ $carriers -ge ${DISCOVER_MIN_CARRIERS[$gid]} ]]; then
    DISCOVERED_IDS+=("$gid")
    echo "  + Candidate '$gid' (${DISCOVER_NAME[$gid]}) â€” carriers: $carriers/${#SKILLS[@]}"
  fi
done

if [[ ${#DISCOVERED_IDS[@]} -eq 0 ]]; then
  echo "  No high-signal candidates found."
  exit 0
fi

if [[ "$SYNC_DISCOVERED" == "false" ]]; then
  echo "  Registry sync disabled via --no-sync-discovery."
  exit 0
fi

echo "  Syncing candidates into 'Proposed Genes' table..."
SYNCED=0
for gid in "${DISCOVERED_IDS[@]}"; do
  if append_proposed_gene \
    "$gid" \
    "${DISCOVER_NAME[$gid]}" \
    "${DISCOVER_DETECT_TYPE[$gid]}" \
    "${DISCOVER_DETECT_ARGS[$gid]}" \
    "${DISCOVER_RECOMMEND[$gid]}" \
    "${DISCOVER_WEIGHT[$gid]}" \
    "${DISCOVER_DESC[$gid]}"; then
    SYNCED=$((SYNCED + 1))
  fi
done

if [[ $SYNCED -gt 0 ]]; then
  echo "  ${GREEN}Gene registry updated with $SYNCED proposed gene(s).${NC}"
else
  echo "  No registry updates were required."
fi
